<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitar Croqui - Prefeitura de Botucatu</title>
  <!-- Importação do Supabase via módulo (mesmo padrão do cadastro/login) -->
  <script type="module">
    import { supabase } from './js/supabaseClient.js';
    window.supabase = supabase; // disponibiliza globalmente se necessário (opcional)
  </script>
  <style>
    /* Estilos mínimos para funcionalidade */
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    .sidebar { float: left; width: 200px; margin-right: 20px; }
    .content { float: left; width: 550px; }
    .clear { clear: both; }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; }
    input[type=text], input[type=file] { width: 100%; padding: 8px; }
    .tooltip { position: relative; display: inline-block; margin-left: 5px; cursor: help; }
    .tooltip .tooltiptext { visibility: hidden; width: 250px; background-color: #555; color: #fff; text-align: center; padding: 5px; border-radius: 6px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -125px; opacity: 0; transition: opacity 0.3s; }
    .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    .notificacao { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .status-pending { color: orange; }
    .status-approved { color: green; }
    .status-denied { color: red; }
    .status-forwarded { color: blue; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Solicitação de Croqui</h2>

    <!-- Área de verificação de login (inicialmente oculta, será exibida pelo JS) -->
    <div id="loginVerification" style="display: none; background: #fee2e2; padding: 20px; border-radius: 8px;">
      <p style="color: #b91c1c; font-weight: bold;">Você não está logado.</p>
      <p><a href="login.html" style="background: #2563eb; color: white; padding: 8px 16px; border-radius: 30px; text-decoration: none;">Fazer login</a></p>
    </div>

    <!-- Conteúdo principal (inicialmente oculto, será exibido se logado) -->
    <div id="mainContent" style="display: none;">
      <!-- Sidebar com dados do munícipe e notificações -->
      <div class="sidebar">
        <div id="perfil">
          <h3>Olá, <span id="nomeUsuario"></span>!</h3>
          <p><strong>CPF:</strong> <span id="cpfUsuario"></span></p>
          <p><strong>E-mail:</strong> <span id="emailUsuario"></span></p>
        </div>

        <h4>Notificações</h4>
        <div id="notificacoes">
          <p>Carregando...</p>
        </div>
      </div>

      <!-- Formulário de solicitação -->
      <div class="content">
        <form id="solicitacaoForm">
          <div class="form-group">
            <label for="iptu">
              Identificação do imóvel
              <span class="tooltip">❓
                <span class="tooltiptext">Número do IPTU do imóvel (formato XX.XXXX.XXXX)</span>
              </span>
            </label>
            <input type="text" id="iptu" name="iptu" placeholder="00.0000.0000" maxlength="12" required>
            <small>Apenas números, formato XX.XXXX.XXXX</small>
          </div>

          <div class="form-group">
            <label for="documento">
              Documento de posse
              <span class="tooltip">❓
                <span class="tooltiptext">Matrícula, Escritura ou contrato de compra e venda validado por cartório ou assinatura digital</span>
              </span>
            </label>
            <input type="file" id="documento" name="documento" accept=".pdf,.jpg,.jpeg,.png" required>
          </div>

          <div class="form-group">
            <label for="quadra">Quadra</label>
            <input type="text" id="quadra" name="quadra" maxlength="5" placeholder="Apenas números (máx 5)" required>
          </div>

          <div class="form-group">
            <label for="lote">Lote</label>
            <input type="text" id="lote" name="lote" maxlength="4" placeholder="Apenas números (máx 4)" required>
          </div>

          <div class="form-group">
            <label for="logradouro">Logradouro</label>
            <input type="text" id="logradouro" name="logradouro" placeholder="Rua, Avenida, etc." required>
          </div>

          <button type="submit">Enviar solicitação</button>
        </form>
        <div id="mensagem"></div>
      </div>
      <div class="clear"></div>
    </div>
  </div>

  <script type="module">
    // ==================== CONFIGURAÇÃO SUPABASE ====================
    // Importa o cliente já configurado do seu arquivo central
    import { supabase } from './js/supabaseClient.js';

    // ==================== UTILITÁRIOS ====================
    function formatIPTU(value) {
      return value.replace(/\D/g, '')
        .replace(/(\d{2})(\d)/, '$1.$2')
        .replace(/(\d{4})(\d)/, '$1.$2')
        .replace(/(\d{4})\d+?$/, '$1');
    }

    // Máscaras - só aplica se os elementos existirem
    function aplicarMascaras() {
      const iptuField = document.getElementById('iptu');
      if (iptuField) {
        iptuField.addEventListener('input', function(e) {
          e.target.value = formatIPTU(e.target.value);
        });
      }

      const quadraField = document.getElementById('quadra');
      if (quadraField) {
        quadraField.addEventListener('input', function(e) {
          e.target.value = e.target.value.replace(/\D/g, '').slice(0, 5);
        });
      }

      const loteField = document.getElementById('lote');
      if (loteField) {
        loteField.addEventListener('input', function(e) {
          e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
        });
      }
    }

    // ==================== VERIFICAÇÃO DE LOGIN ====================
    function checkLogin() {
      const userStr = localStorage.getItem('user');
      const loginDiv = document.getElementById('loginVerification');
      const mainDiv = document.getElementById('mainContent');

      if (!userStr) {
        if (loginDiv) loginDiv.style.display = 'block';
        if (mainDiv) mainDiv.style.display = 'none';
        return null;
      }
      try {
        const user = JSON.parse(userStr);
        if (loginDiv) loginDiv.style.display = 'none';
        if (mainDiv) mainDiv.style.display = 'block';
        return user;
      } catch (e) {
        localStorage.removeItem('user');
        if (loginDiv) loginDiv.style.display = 'block';
        if (mainDiv) mainDiv.style.display = 'none';
        return null;
      }
    }

    // ==================== CARREGAR DADOS DO USUÁRIO ====================
    async function carregarDadosUsuario(user) {
      document.getElementById('nomeUsuario').textContent = user.nome || 'Usuário';
      document.getElementById('cpfUsuario').textContent = user.cpf || '';
      
      // Buscar e-mail na tabela municipes
      const { data, error } = await supabase
        .from('municipes')
        .select('email')
        .eq('cpf', user.cpf)
        .maybeSingle();
      
      if (data && data.email) {
        document.getElementById('emailUsuario').textContent = data.email;
      } else {
        document.getElementById('emailUsuario').textContent = 'Não informado';
      }
    }

    // ==================== CARREGAR NOTIFICAÇÕES ====================
    async function carregarNotificacoes(user) {
      const divNotificacoes = document.getElementById('notificacoes');
      
      const { data, error } = await supabase
        .from('croqui_requests')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Erro ao carregar notificações:', error);
        divNotificacoes.innerHTML = '<p>Erro ao carregar notificações.</p>';
        return;
      }

      if (!data || data.length === 0) {
        divNotificacoes.innerHTML = '<p>Você ainda não fez nenhuma solicitação.</p>';
        return;
      }

      let html = '';
      data.forEach(sol => {
        let statusClass = '';
        let statusText = '';
        switch (sol.status) {
          case 'pending': statusClass = 'status-pending'; statusText = '⏳ Pendente'; break;
          case 'approved': statusClass = 'status-approved'; statusText = '✅ Aprovado'; break;
          case 'denied': statusClass = 'status-denied'; statusText = '❌ Negado'; break;
          case 'forwarded': statusClass = 'status-forwarded'; statusText = '↪️ Encaminhado'; break;
          default: statusClass = ''; statusText = sol.status;
        }
        html += `<div class="notificacao">
          <strong>${sol.logradouro}</strong><br>
          <span class="${statusClass}">${statusText}</span><br>
          <small>${new Date(sol.created_at).toLocaleDateString('pt-BR')}</small>
        </div>`;
      });
      divNotificacoes.innerHTML = html;
    }

    // ==================== ENVIO DA SOLICITAÇÃO ====================
    async function enviarSolicitacao(user, formData) {
      const msgDiv = document.getElementById('mensagem');
      msgDiv.style.color = 'red';
      msgDiv.textContent = '';

      // Validações
      if (!formData.iptu || formData.iptu.replace(/\D/g, '').length < 10) {
        msgDiv.textContent = 'IPTU inválido. Preencha no formato XX.XXXX.XXXX.';
        return;
      }
      if (!formData.quadra || formData.quadra.length === 0) {
        msgDiv.textContent = 'Preencha a quadra.';
        return;
      }
      if (!formData.lote || formData.lote.length === 0) {
        msgDiv.textContent = 'Preencha o lote.';
        return;
      }
      if (!formData.logradouro) {
        msgDiv.textContent = 'Preencha o logradouro.';
        return;
      }
      if (!formData.documento) {
        msgDiv.textContent = 'Selecione um documento.';
        return;
      }

      const btn = document.querySelector('button[type=submit]');
      btn.disabled = true;
      btn.textContent = 'Enviando...';

      try {
        const file = formData.documento;
        const fileExt = file.name.split('.').pop();
        const fileName = `${user.id}/${Date.now()}.${fileExt}`;

        // Upload para o bucket 'documentos'
        const { error: uploadError } = await supabase.storage
          .from('documentos')
          .upload(fileName, file);

        if (uploadError) {
          console.error('Erro upload:', uploadError);
          throw new Error('Falha ao enviar o documento. Tente novamente.');
        }

        // Obter URL pública
        const { data: urlData } = supabase.storage
          .from('documentos')
          .getPublicUrl(fileName);

        const documentUrl = urlData.publicUrl;

        // Inserir solicitação
        const { error: insertError } = await supabase
          .from('croqui_requests')
          .insert([{
            user_id: user.id,
            iptu: formData.iptu,
            document_url: documentUrl,
            quadra: formData.quadra,
            lote: formData.lote,
            logradouro: formData.logradouro,
            status: 'pending'
          }]);

        if (insertError) {
          console.error('Erro insert:', insertError);
          throw new Error('Erro ao salvar a solicitação.');
        }

        msgDiv.style.color = 'green';
        msgDiv.textContent = 'Solicitação enviada com sucesso!';
        btn.disabled = false;
        btn.textContent = 'Enviar solicitação';

        // Limpar formulário
        document.getElementById('solicitacaoForm').reset();

        // Recarregar notificações
        carregarNotificacoes(user);
      } catch (error) {
        console.error(error);
        msgDiv.style.color = 'red';
        msgDiv.textContent = error.message || 'Erro ao enviar solicitação.';
        btn.disabled = false;
        btn.textContent = 'Enviar solicitação';
      }
    }

    // ==================== INICIALIZAÇÃO ====================
    document.addEventListener('DOMContentLoaded', async () => {
      aplicarMascaras();

      const user = checkLogin();
      if (!user) return;

      await carregarDadosUsuario(user);
      await carregarNotificacoes(user);

      document.getElementById('solicitacaoForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const iptu = document.getElementById('iptu').value.trim();
        const quadra = document.getElementById('quadra').value.trim();
        const lote = document.getElementById('lote').value.trim();
        const logradouro = document.getElementById('logradouro').value.trim();
        const documento = document.getElementById('documento').files[0];

        const formData = { iptu, quadra, lote, logradouro, documento };
        await enviarSolicitacao(user, formData);
      });
    });
  </script>
</body>
</html>
