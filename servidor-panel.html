<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Servidor - Prefeitura de Botucatu</title>
  <style>
    /* Mesmos estilos anteriores, com pequenos ajustes */
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .sidebar { float: left; width: 300px; margin-right: 20px; }
    .content { float: left; width: calc(100% - 340px); }
    .clear { clear: both; }
    .panel { background: #f9f9f9; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
    .request-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
    .request-list li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    .request-list li:hover { background: #e6f7ff; }
    .selected { background: #bae7ff; font-weight: bold; }
    .detail-row { margin-bottom: 8px; }
    .detail-label { font-weight: bold; display: inline-block; width: 180px; }
    .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
    .btn-approve { background: #52c41a; color: white; }
    .btn-deny { background: #ff4d4f; color: white; }
    .btn-primary { background: #2563eb; color: white; }
    .btn:hover { opacity: 0.9; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f2f2f2; }
    .error { color: red; }
    .success { color: green; }
    .action-buttons { margin-top: 20px; }
    .back-btn { margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Painel do Servidor</h2>
      <button id="logoutBtn" class="btn" style="background: #ff4d4f; color: white;">Sair</button>
    </div>

    <div id="loginVerification" style="display: none; background: #fee; padding: 20px;">
      <p style="color: red;">Voc√™ n√£o est√° logado como servidor.</p>
      <a href="servidor-login.html">Ir para login</a>
    </div>

    <div id="mainContent" style="display: block;">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="panel">
          <h3>Servidor</h3>
          <p><strong>Nome:</strong> <span id="servidorNome"></span></p>
          <p><strong>RI:</strong> <span id="servidorRI"></span></p>
        </div>

        <div class="panel">
          <h3>Solicita√ß√µes Pendentes</h3>
          <ul id="pendingList" class="request-list">
            <li>Carregando...</li>
          </ul>
        </div>

        <div class="panel">
          <h3>Consultas</h3>
          <button id="viewAttendedBtn" class="btn btn-primary" style="width:100%;">üìã Ver Solicita√ß√µes Atendidas</button>
        </div>
      </div>

      <!-- Conte√∫do principal -->
      <div class="content">
        <!-- √Årea de detalhes da solicita√ß√£o (vis√≠vel por padr√£o) -->
        <div id="requestDetailsArea">
          <div id="requestDetails" class="panel">
            <h3>Detalhes da Solicita√ß√£o</h3>
            <p>Selecione uma solicita√ß√£o na lista ao lado.</p>
          </div>

          <div id="actionArea" style="display: none;">
            <div class="action-buttons">
              <button id="approveBtn" class="btn btn-approve">Deferir (aprovar)</button>
              <button id="denyBtn" class="btn btn-deny">Indeferir (negar)</button>
            </div>
            
            <div id="approveArea" style="display: none; margin-top: 20px;">
              <h4>Anexar Croqui (Deferir)</h4>
              <input type="file" id="croquiFile" accept=".pdf,.jpg,.jpeg,.png">
              <button id="confirmApproveBtn" class="btn btn-approve" style="margin-top: 10px;">Confirmar Deferimento</button>
            </div>
            
            <div id="denyArea" style="display: none; margin-top: 20px;">
              <h4>Motivo do Indeferimento</h4>
              <textarea id="denyReason" rows="4" style="width: 100%;"></textarea>
              <button id="confirmDenyBtn" class="btn btn-deny" style="margin-top: 10px;">Confirmar Indeferimento</button>
            </div>
          </div>
        </div>

        <!-- √Årea da tabela de atendidas (inicialmente oculta) -->
        <div id="attendedTableArea" style="display: none;">
          <div class="panel">
            <div class="back-btn">
              <button id="backToDetailsBtn" class="btn btn-primary">‚Üê Voltar para detalhes</button>
            </div>
            <h3>Todas as Solicita√ß√µes Atendidas</h3>
            <div id="attendedTableContainer"></div>
          </div>
        </div>

        <div id="message" style="margin-top: 20px;"></div>
      </div>
      <div class="clear"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './js/supabaseClient.js';

    // ===== VERIFICA√á√ÉO DE LOGIN DO SERVIDOR =====
    const servidorSession = localStorage.getItem('servidor');
    const loginVerification = document.getElementById('loginVerification');
    const mainContent = document.getElementById('mainContent');

    if (!servidorSession) {
      loginVerification.style.display = 'block';
      mainContent.style.display = 'none';
      throw new Error('Servidor n√£o logado');
    }

    let servidor;
    try {
      servidor = JSON.parse(servidorSession);
      document.getElementById('servidorNome').textContent = servidor.nome || 'Servidor';
      document.getElementById('servidorRI').textContent = servidor.ri || '';
    } catch (e) {
      localStorage.removeItem('servidor');
      window.location.href = 'servidor-login.html';
    }

    loginVerification.style.display = 'none';
    mainContent.style.display = 'block';

    // ===== VARI√ÅVEIS GLOBAIS =====
    let selectedRequestId = null;

    // ===== FUN√á√ïES AUXILIARES =====
    async function buscarMunicipePorUserId(userId) {
      const { data, error } = await supabase
        .from('municipes')
        .select('*')
        .eq('id', userId)
        .maybeSingle();
      if (error) {
        console.error('Erro ao buscar mun√≠cipe:', error);
        return null;
      }
      return data;
    }

    async function buscarServidorPorId(servidorId) {
      if (!servidorId) return null;
      const { data, error } = await supabase
        .from('servidores')
        .select('nome, ri')
        .eq('id', servidorId)
        .maybeSingle();
      if (error) {
        console.error('Erro ao buscar servidor:', error);
        return null;
      }
      return data;
    }

    // ===== CARREGAR PENDENTES =====
    async function carregarPendentes() {
      const { data, error } = await supabase
        .from('croqui_requests')
        .select('id, user_id, iptu, logradouro, quadra, lote, created_at')
        .eq('status', 'pending')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Erro ao carregar pendentes:', error);
        document.getElementById('pendingList').innerHTML = '<li style="color:red;">Erro ao carregar pendentes.</li>';
        return;
      }

      const listEl = document.getElementById('pendingList');
      if (!data || data.length === 0) {
        listEl.innerHTML = '<li>Nenhuma solicita√ß√£o pendente.</li>';
        return;
      }

      let html = '';
      for (const req of data) {
        const municipe = await buscarMunicipePorUserId(req.user_id);
        const nome = municipe?.full_name || 'Desconhecido';
        html += `
          <li onclick="window.selecionarSolicitacao('${req.id}')" class="${selectedRequestId === req.id ? 'selected' : ''}">
            <strong>${nome}</strong><br>
            ${req.logradouro || ''} - ${req.created_at ? new Date(req.created_at).toLocaleDateString('pt-BR') : ''}
          </li>
        `;
      }
      listEl.innerHTML = html;
    }

    // ===== CARREGAR DETALHES =====
    window.selecionarSolicitacao = async (id) => {
      // Esconder tabela de atendidas se estiver vis√≠vel e mostrar √°rea de detalhes
      document.getElementById('attendedTableArea').style.display = 'none';
      document.getElementById('requestDetailsArea').style.display = 'block';

      selectedRequestId = id;
      
      const { data: request, error } = await supabase
        .from('croqui_requests')
        .select('*')
        .eq('id', id)
        .single();

      if (error || !request) {
        document.getElementById('requestDetails').innerHTML = '<p style="color:red;">Erro ao carregar detalhes.</p>';
        return;
      }

      const municipe = await buscarMunicipePorUserId(request.user_id);
      
      let html = `
        <h3>Detalhes da Solicita√ß√£o</h3>
        <div class="detail-row"><span class="detail-label">Nome do mun√≠cipe:</span> ${municipe?.full_name || ''}</div>
        <div class="detail-row"><span class="detail-label">Nome do pai:</span> ${municipe?.father_name || ''}</div>
        <div class="detail-row"><span class="detail-label">Nome da m√£e:</span> ${municipe?.mother_name || ''}</div>
        <div class="detail-row"><span class="detail-label">CPF:</span> ${municipe?.cpf || ''}</div>
        <div class="detail-row"><span class="detail-label">Identifica√ß√£o do im√≥vel:</span> ${request.iptu || ''}</div>
        <div class="detail-row"><span class="detail-label">Logradouro:</span> ${request.logradouro || ''}</div>
        <div class="detail-row"><span class="detail-label">Quadra:</span> ${request.quadra || ''}</div>
        <div class="detail-row"><span class="detail-label">Lote:</span> ${request.lote || ''}</div>
        <div class="detail-row"><span class="detail-label">Documento de posse:</span> 
      `;

      if (request.document_url) {
        html += `<a href="${request.document_url}" target="_blank">Visualizar documento</a>`;
      } else {
        html += 'N√£o enviado';
      }
      html += `</div>`;

      document.getElementById('requestDetails').innerHTML = html;
      
      // Mostra a √°rea de a√ß√µes
      document.getElementById('actionArea').style.display = 'block';
      document.getElementById('approveArea').style.display = 'none';
      document.getElementById('denyArea').style.display = 'none';
      
      await carregarPendentes(); // atualiza classe selected
    };

    // ===== CARREGAR TABELA DE ATENDIDAS =====
    async function carregarTabelaAtendidas() {
      const container = document.getElementById('attendedTableContainer');
      container.innerHTML = '<p>Carregando...</p>';

      const { data, error } = await supabase
        .from('croqui_requests')
        .select('*')
        .in('status', ['approved', 'denied', 'forwarded'])
        .order('analyzed_at', { ascending: false });

      if (error) {
        console.error('Erro ao carregar atendidas:', error);
        container.innerHTML = '<p style="color:red;">Erro ao carregar atendidas.</p>';
        return;
      }

      if (!data || data.length === 0) {
        container.innerHTML = '<p>Nenhuma solicita√ß√£o atendida ainda.</p>';
        return;
      }

      let html = `<table>
        <thead>
          <tr>
            <th>Mun√≠cipe</th>
            <th>Endere√ßo</th>
            <th>Status</th>
            <th>Servidor</th>
            <th>RI</th>
            <th>Data</th>
            <th>Motivo (se negado)</th>
            <th>Croqui</th>
          </tr>
        </thead>
        <tbody>
      `;

      for (const req of data) {
        const municipe = await buscarMunicipePorUserId(req.user_id);
        const servidorInfo = await buscarServidorPorId(req.analyzed_by);
        
        let statusText = '';
        if (req.status === 'approved') statusText = '‚úÖ Deferido';
        else if (req.status === 'denied') statusText = '‚ùå Indeferido';
        else if (req.status === 'forwarded') statusText = '‚Ü™Ô∏è Encaminhado';
        else statusText = req.status;
        
        html += `<tr>
          <td>${municipe?.full_name || '-'}</td>
          <td>${req.logradouro || '-'}</td>
          <td>${statusText}</td>
          <td>${servidorInfo?.nome || '-'}</td>
          <td>${servidorInfo?.ri || '-'}</td>
          <td>${req.analyzed_at ? new Date(req.analyzed_at).toLocaleDateString('pt-BR') : '-'}</td>
          <td>${req.denial_reason || '-'}</td>
          <td>${req.deferred_document_url ? `<a href="${req.deferred_document_url}" target="_blank">Ver croqui</a>` : '-'}</td>
        </tr>`;
      }

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    // ===== CONFIGURA√á√ÉO DOS BOT√ïES =====
    function setupActionButtons() {
      // Bot√£o Deferir
      document.getElementById('approveBtn').addEventListener('click', () => {
        document.getElementById('approveArea').style.display = 'block';
        document.getElementById('denyArea').style.display = 'none';
      });

      // Bot√£o Indeferir
      document.getElementById('denyBtn').addEventListener('click', () => {
        document.getElementById('denyArea').style.display = 'block';
        document.getElementById('approveArea').style.display = 'none';
      });

      // Confirmar Deferimento
      document.getElementById('confirmApproveBtn').addEventListener('click', async () => {
        if (!selectedRequestId) {
          alert('Nenhuma solicita√ß√£o selecionada.');
          return;
        }

        const fileInput = document.getElementById('croquiFile');
        const file = fileInput.files[0];
        if (!file) {
          alert('Selecione o arquivo do croqui.');
          return;
        }

        try {
          console.log('Enviando deferimento para solicita√ß√£o:', selectedRequestId);
          
          const fileName = `croquis/${selectedRequestId}_${Date.now()}.${file.name.split('.').pop()}`;
          const { error: uploadError } = await supabase.storage
            .from('documentos')
            .upload(fileName, file);
          if (uploadError) throw uploadError;

          const { data: urlData } = supabase.storage
            .from('documentos')
            .getPublicUrl(fileName);
          const croquiUrl = urlData.publicUrl;

          const { error: updateError } = await supabase
            .from('croqui_requests')
            .update({
              status: 'approved',
              analyzed_by: servidor.id,
              deferred_document_url: croquiUrl,
              analyzed_at: new Date()
            })
            .eq('id', selectedRequestId);

          if (updateError) throw updateError;

          alert('Solicita√ß√£o deferida com sucesso!');
          
          fileInput.value = '';
          document.getElementById('approveArea').style.display = 'none';
          document.getElementById('actionArea').style.display = 'none';
          document.getElementById('requestDetails').innerHTML = '<h3>Detalhes da Solicita√ß√£o</h3><p>Selecione uma solicita√ß√£o na lista ao lado.</p>';
          
          selectedRequestId = null;
          await carregarPendentes();
          // Se a tabela de atendidas estiver vis√≠vel, recarreg√°-la tamb√©m
          if (document.getElementById('attendedTableArea').style.display === 'block') {
            await carregarTabelaAtendidas();
          }
        } catch (err) {
          console.error('Erro ao deferir:', err);
          alert('Erro ao deferir: ' + err.message);
        }
      });

      // Confirmar Indeferimento
      document.getElementById('confirmDenyBtn').addEventListener('click', async () => {
        if (!selectedRequestId) {
          alert('Nenhuma solicita√ß√£o selecionada.');
          return;
        }

        const reason = document.getElementById('denyReason').value.trim();
        if (!reason) {
          alert('Digite o motivo do indeferimento.');
          return;
        }

        try {
          console.log('Enviando indeferimento para solicita√ß√£o:', selectedRequestId);
          
          const { error: updateError } = await supabase
            .from('croqui_requests')
            .update({
              status: 'denied',
              analyzed_by: servidor.id,
              denial_reason: reason,
              analyzed_at: new Date()
            })
            .eq('id', selectedRequestId);

          if (updateError) throw updateError;

          alert('Solicita√ß√£o indeferida com sucesso!');
          
          document.getElementById('denyReason').value = '';
          document.getElementById('denyArea').style.display = 'none';
          document.getElementById('actionArea').style.display = 'none';
          document.getElementById('requestDetails').innerHTML = '<h3>Detalhes da Solicita√ß√£o</h3><p>Selecione uma solicita√ß√£o na lista ao lado.</p>';
          
          selectedRequestId = null;
          await carregarPendentes();
          if (document.getElementById('attendedTableArea').style.display === 'block') {
            await carregarTabelaAtendidas();
          }
        } catch (err) {
          console.error('Erro ao indeferir:', err);
          alert('Erro ao indeferir: ' + err.message);
        }
      });
    }

    // ===== EVENTOS DE NAVEGA√á√ÉO =====
    document.getElementById('viewAttendedBtn').addEventListener('click', async () => {
      // Esconder √°rea de detalhes e mostrar tabela de atendidas
      document.getElementById('requestDetailsArea').style.display = 'none';
      document.getElementById('attendedTableArea').style.display = 'block';
      await carregarTabelaAtendidas();
    });

    document.getElementById('backToDetailsBtn').addEventListener('click', () => {
      document.getElementById('attendedTableArea').style.display = 'none';
      document.getElementById('requestDetailsArea').style.display = 'block';
      // Se houver uma solicita√ß√£o selecionada, recarrega seus detalhes
      if (selectedRequestId) {
        window.selecionarSolicitacao(selectedRequestId);
      }
    });

    // ===== LOGOUT =====
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('servidor');
      window.location.href = 'servidor-login.html';
    });

    // ===== INICIALIZA√á√ÉO =====
    (async () => {
      await carregarPendentes();
      setupActionButtons();
    })();
  </script>
</body>
</html>
