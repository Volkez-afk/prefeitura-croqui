<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Servidor - Prefeitura de Botucatu</title>

  <!-- Fontes e √≠cones -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ========== RESET E VARI√ÅVEIS ========== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
      color: #1e293b;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; width: 100%; }

    /* ========== BARRA DE ACESSIBILIDADE ========== */
    .accessibility-bar {
      background-color: #0a4b6e;
      color: white;
      padding: 8px 0;
      font-size: 13px;
    }
    .accessibility-bar .container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }
    .accessibility-links {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .accessibility-links a {
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: opacity 0.2s;
    }
    .accessibility-links a:hover {
      opacity: 0.9;
      text-decoration: underline;
    }

    /* ========== CABE√áALHO PRINCIPAL ========== */
    .main-header {
      background-color: white;
      padding: 30px 0 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .main-header .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    .logo-area {
      display: flex;
      align-items: center;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .logo-brasao {
      width: 80px;
      height: 80px;
      object-fit: contain;
    }
    .titulos-prefeitura {
      display: flex;
      flex-direction: column;
    }
    .titulo-principal {
      font-size: 26px;
      font-weight: 800;
      color: #0a4b6e;
      line-height: 1.2;
    }
    .subtitulo {
      font-size: 16px;
      color: #475569;
      font-weight: 500;
    }

    /* ========== MENU DE NAVEGA√á√ÉO ========== */
    .nav-menu {
      background-color: white;
      border-top: 1px solid #e2e8f0;
      padding: 12px 0;
    }
    .nav-menu .container {
      display: flex;
      justify-content: center;
    }
    .nav-links {
      display: flex;
      list-style: none;
      gap: 32px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .nav-links a {
      color: #1e293b;
      text-decoration: none;
      font-weight: 600;
      font-size: 15px;
      padding: 6px 0;
      border-bottom: 2px solid transparent;
      transition: 0.2s;
    }
    .nav-links a:hover,
    .nav-links a.active {
      color: #0a4b6e;
      border-bottom-color: #0a4b6e;
    }

    /* ========== LAYOUT PRINCIPAL (DASHBOARD) ========== */
    .dashboard {
      display: flex;
      gap: 30px;
      margin: 40px auto;
      flex: 1;
      max-width: 1280px;
      padding: 0 24px;
    }

    /* ----- SIDEBAR ----- */
    .sidebar {
      width: 320px;
      flex-shrink: 0;
      background: white;
      border-radius: 20px;
      padding: 28px 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
      border: 1px solid #e2e8f0;
      align-self: start;
    }
    .perfil-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e2e8f0;
    }
    .perfil-avatar {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #0a4b6e, #2563eb);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 28px;
    }
    .perfil-nome h3 {
      font-size: 18px;
      font-weight: 700;
      color: #0f172a;
    }
    .perfil-dados {
      margin-bottom: 28px;
    }
    .perfil-dados h4,
    .notificacoes h4 {
      font-size: 16px;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dados-lista {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .dado-item {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }
    .dado-label {
      color: #64748b;
    }
    .dado-value {
      font-weight: 600;
      color: #0f172a;
    }

    /* ----- LISTA DE PENDENTES (ESTILO NOTIFICA√á√ïES) ----- */
    .pending-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 400px;
      overflow-y: auto;
    }
    .pending-list li {
      background: #f8fafc;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border-left: 4px solid #f59e0b;
      cursor: pointer;
      transition: all 0.2s;
    }
    .pending-list li:hover {
      background: #f1f5f9;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    }
    .pending-list li.selected {
      background: #e0f2fe;
      border-left-color: #2563eb;
    }
    .pending-list strong {
      color: #0f172a;
      font-size: 15px;
    }
    .pending-list small {
      color: #64748b;
      font-size: 12px;
    }

    /* ----- BOT√ïES ----- */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 30px;
      font-weight: 600;
      font-size: 15px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }
    .btn-primary {
      background-color: #2563eb;
      color: white;
    }
    .btn-primary:hover {
      background-color: #1d4ed8;
      transform: scale(1.02);
    }
    .btn-approve {
      background-color: #10b981;
      color: white;
    }
    .btn-approve:hover {
      background-color: #059669;
      transform: scale(1.02);
    }
    .btn-deny {
      background-color: #ef4444;
      color: white;
    }
    .btn-deny:hover {
      background-color: #dc2626;
      transform: scale(1.02);
    }
    .btn-outline {
      background-color: white;
      border: 1px solid #cbd5e1;
      color: #1e293b;
    }
    .btn-outline:hover {
      background-color: #f1f5f9;
    }

    /* ----- √ÅREA DE CONTE√öDO ----- */
    .main-content {
      flex: 1;
      background: white;
      border-radius: 20px;
      padding: 32px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
      border: 1px solid #e2e8f0;
    }

    /* ----- DETALHES DA SOLICITA√á√ÉO ----- */
    .detail-card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .detail-row {
      display: flex;
      margin-bottom: 12px;
    }
    .detail-label {
      font-weight: 600;
      color: #475569;
      width: 200px;
      flex-shrink: 0;
    }
    .detail-value {
      color: #0f172a;
    }

    /* ----- √ÅREA DE UPLOAD E TEXTO ----- */
    .upload-area {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      background: #f8fafc;
      margin-top: 16px;
      cursor: pointer;
    }
    .upload-area:hover {
      border-color: #2563eb;
      background: #eff6ff;
    }
    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      resize: vertical;
    }
    textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
    }

    /* ----- TABELA DE ATENDIDAS ----- */
    .table-responsive {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    th {
      text-align: left;
      padding: 12px;
      background: #f1f5f9;
      color: #0f172a;
      font-weight: 600;
      font-size: 14px;
    }
    td {
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
    }
    tr:hover td {
      background: #f8fafc;
    }
    .status-link {
      color: #2563eb;
      text-decoration: underline;
      cursor: pointer;
      font-weight: 600;
    }
    .status-link:hover {
      color: #1d4ed8;
    }

    /* ----- MENSAGENS ----- */
    .alert {
      padding: 16px;
      border-radius: 12px;
      margin-top: 20px;
    }
    .alert-success {
      background: #dcfce7;
      color: #166534;
    }
    .alert-error {
      background: #fee2e2;
      color: #b91c1c;
    }

    /* ========== RODAP√â ========== */
    footer {
      background-color: #0f172a;
      color: white;
      padding: 32px 0 24px;
      margin-top: auto;
    }
    .footer-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 20px;
    }
    .footer-contact {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      justify-content: center;
      color: #cbd5e1;
      font-size: 15px;
    }
    .footer-contact a {
      color: #cbd5e1;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: color 0.2s;
    }
    .footer-contact a:hover {
      color: white;
    }
    .footer-bottom {
      color: #94a3b8;
      font-size: 13px;
    }

    /* ========== RESPONSIVIDADE ========== */
    @media (max-width: 900px) {
      .dashboard {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
      }
    }
    @media (max-width: 640px) {
      .footer-contact {
        flex-direction: column;
        gap: 12px;
      }
      .detail-row {
        flex-direction: column;
        gap: 4px;
      }
      .detail-label {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- ========== BARRA DE ACESSIBILIDADE ========== -->
  <div class="accessibility-bar">
    <div class="container">
      <div class="accessibility-links">
        <a href="#"><i class="fas fa-plus-circle"></i> Aumentar Fonte</a>
        <a href="#"><i class="fas fa-minus-circle"></i> Diminuir Fonte</a>
        <a href="#"><i class="fas fa-adjust"></i> Alto Contraste</a>
        <a href="#"><i class="fas fa-hands"></i> Libras</a>
        <a href="#"><i class="fas fa-sitemap"></i> Mapa do Site</a>
      </div>
    </div>
  </div>

  <!-- ========== CABE√áALHO ========== -->
  <div class="main-header">
    <div class="container">
      <div class="logo-area">
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/4f/Bras%C3%A3o_de_Botucatu.jpg" alt="Bras√£o de Botucatu" class="logo-brasao">
        <div class="titulos-prefeitura">
          <span class="titulo-principal">Prefeitura Municipal de Botucatu</span>
          <span class="subtitulo">Painel do Servidor</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== MENU ========== -->
  <div class="nav-menu">
    <div class="container">
      <ul class="nav-links">
        <li><a href="index.html">In√≠cio</a></li>
        <li><a href="login.html">Mun√≠cipe</a></li>
        <li><a href="servidor-login.html" class="active">Servidor</a></li>
        <li><a href="admin-login.html">Administrador</a></li>
        <li><a href="concess-login.html">SABESP/CPFL</a></li>
      </ul>
    </div>
  </div>

  <!-- ========== CONTE√öDO PRINCIPAL ========== -->
  <div id="mainContent" style="display: none;">
    <div class="dashboard">
      <!-- ========== SIDEBAR ========== -->
      <div class="sidebar">
        <div class="perfil-header">
          <div class="perfil-avatar">
            <i class="fas fa-user-tie"></i>
          </div>
          <div class="perfil-nome">
            <h3 id="servidorNome">Carregando...</h3>
          </div>
        </div>
        <div class="perfil-dados">
          <h4><i class="fas fa-id-card"></i> Dados do Servidor</h4>
          <div class="dados-lista">
            <div class="dado-item">
              <span class="dado-label">RI:</span>
              <span class="dado-value" id="servidorRI"></span>
            </div>
          </div>
        </div>

        <div class="notificacoes">
          <h4><i class="fas fa-clock"></i> Solicita√ß√µes Pendentes</h4>
          <ul id="pendingList" class="pending-list">
            <li>Carregando...</li>
          </ul>
        </div>

        <div style="margin-top: 20px;">
          <button id="viewAttendedBtn" class="btn btn-primary" style="width:100%;">
            <i class="fas fa-history"></i> Ver Solicita√ß√µes Atendidas
          </button>
        </div>
      </div>

      <!-- ========== CONTE√öDO PRINCIPAL ========== -->
      <div class="main-content">
        <!-- √Årea de detalhes da solicita√ß√£o -->
        <div id="requestDetailsArea">
          <div id="requestDetails">
            <h2 style="color: #0a4b6e; margin-bottom: 16px;">Detalhes da Solicita√ß√£o</h2>
            <p style="color: #64748b;">Selecione uma solicita√ß√£o na lista ao lado.</p>
          </div>

          <div id="actionArea" style="display: none; margin-top: 24px;">
            <div style="display: flex; gap: 16px; margin-bottom: 24px;">
              <button id="approveBtn" class="btn btn-approve">
                <i class="fas fa-check-circle"></i> Deferir (aprovar)
              </button>
              <button id="denyBtn" class="btn btn-deny">
                <i class="fas fa-times-circle"></i> Indeferir (negar)
              </button>
            </div>
            
            <div id="approveArea" style="display: none;">
              <h4 style="color: #0f172a; margin-bottom: 12px;">üìé Anexar Croqui (Deferir)</h4>
              <div class="upload-area" id="fileUploadArea">
                <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: #2563eb;"></i>
                <p style="font-weight: 600; margin: 8px 0;">Clique para enviar o croqui</p>
                <small style="color: #64748b;">PDF, JPG ou PNG (m√°x. 10MB)</small>
                <input type="file" id="croquiFile" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
              </div>
              <button id="confirmApproveBtn" class="btn btn-approve" style="margin-top: 20px;">
                <i class="fas fa-paper-plane"></i> Confirmar Deferimento
              </button>
            </div>
            
            <div id="denyArea" style="display: none;">
              <h4 style="color: #0f172a; margin-bottom: 12px;">üìù Motivo do Indeferimento</h4>
              <textarea id="denyReason" rows="4" placeholder="Descreva o motivo do indeferimento..."></textarea>
              <button id="confirmDenyBtn" class="btn btn-deny" style="margin-top: 20px;">
                <i class="fas fa-paper-plane"></i> Confirmar Indeferimento
              </button>
            </div>
          </div>
        </div>

        <!-- √Årea da tabela de atendidas (inicialmente oculta) -->
        <div id="attendedTableArea" style="display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="color: #0a4b6e;">Todas as Solicita√ß√µes Atendidas</h2>
            <button id="backToDetailsBtn" class="btn btn-outline">
              <i class="fas fa-arrow-left"></i> Voltar para detalhes
            </button>
          </div>
          <div id="attendedTableContainer" class="table-responsive">
            <!-- Tabela ser√° inserida aqui -->
          </div>
        </div>

        <div id="message"></div>
      </div>
    </div>
  </div>

  <!-- ========== BOT√ÉO DE LOGOUT FLUTUANTE ========== -->
  <div style="position: fixed; bottom: 20px; right: 20px; z-index: 100;">
    <button id="logoutBtn" class="btn" style="background: #ef4444; color: white; border-radius: 40px; padding: 12px 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
      <i class="fas fa-sign-out-alt"></i> Sair
    </button>
  </div>

  <!-- ========== RODAP√â ========== -->
  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-contact">
          <a href="https://www.botucatu.sp.gov.br" target="_blank"><i class="fas fa-globe"></i> Site oficial</a>
          <span><i class="fas fa-phone-alt"></i> (14) 3811-1400</span>
          <span><i class="fas fa-envelope"></i> gabinete@botucatu.sp.gov.br</span>
          <span><i class="fas fa-clock"></i> Segunda a sexta, 08h √†s 16h30</span>
        </div>
        <div class="footer-bottom">
          ¬© 2026 ‚Äì Prefeitura Municipal de Botucatu. Todos os direitos reservados.
        </div>
      </div>
    </div>
  </footer>

  <script type="module">
    import { supabase } from './js/supabaseClient.js';

    // ========== VERIFICA√á√ÉO DE LOGIN ==========
    const servidorSession = localStorage.getItem('servidor');
    const mainContent = document.getElementById('mainContent');

    if (!servidorSession) {
      window.location.href = 'servidor-login.html';
    }

    let servidor;
    try {
      servidor = JSON.parse(servidorSession);
      const nomeEl = document.getElementById('servidorNome');
      const riEl = document.getElementById('servidorRI');
      if (nomeEl) nomeEl.textContent = servidor.nome || 'Servidor';
      if (riEl) riEl.textContent = servidor.ri || '';
    } catch (e) {
      localStorage.removeItem('servidor');
      window.location.href = 'servidor-login.html';
    }

    if (mainContent) mainContent.style.display = 'block';

    // ========== VARI√ÅVEIS GLOBAIS ==========
    let selectedRequestId = null;
    let selectedServico = null; // NOVA VARI√ÅVEL: armazena o tipo de servi√ßo da solicita√ß√£o

    // ========== FUN√á√ïES AUXILIARES ==========
    async function buscarMunicipePorUserId(userId) {
      const { data, error } = await supabase
        .from('municipes')
        .select('*')
        .eq('id', userId)
        .maybeSingle();
      if (error) {
        console.error('Erro ao buscar mun√≠cipe:', error);
        return null;
      }
      return data;
    }

    async function buscarServidorPorId(servidorId) {
      if (!servidorId) return null;
      const { data, error } = await supabase
        .from('servidores')
        .select('nome, ri')
        .eq('id', servidorId)
        .maybeSingle();
      if (error) {
        console.error('Erro ao buscar servidor:', error);
        return null;
      }
      return data;
    }

    // ========== CARREGAR PENDENTES ==========
    async function carregarPendentes() {
      const listEl = document.getElementById('pendingList');
      if (!listEl) return;

      const { data, error } = await supabase
        .from('croqui_requests')
        .select('id, user_id, iptu, logradouro, quadra, lote, created_at')
        .eq('status', 'pending')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Erro ao carregar pendentes:', error);
        listEl.innerHTML = '<li style="color:red;">Erro ao carregar pendentes.</li>';
        return;
      }

      if (!data || data.length === 0) {
        listEl.innerHTML = '<li>Nenhuma solicita√ß√£o pendente.</li>';
        return;
      }

      let html = '';
      for (const req of data) {
        const municipe = await buscarMunicipePorUserId(req.user_id);
        const nome = municipe?.full_name || 'Desconhecido';
        html += `
          <li onclick="window.selecionarSolicitacao('${req.id}')" class="${selectedRequestId === req.id ? 'selected' : ''}">
            <strong>${nome}</strong><br>
            <small>${req.logradouro || ''} - ${req.created_at ? new Date(req.created_at).toLocaleDateString('pt-BR') : ''}</small>
          </li>
        `;
      }
      listEl.innerHTML = html;
    }

    // ========== SELECIONAR SOLICITA√á√ÉO (ATUALIZADA) ==========
    window.selecionarSolicitacao = async (id) => {
      const attendedArea = document.getElementById('attendedTableArea');
      const detailsArea = document.getElementById('requestDetailsArea');
      if (attendedArea) attendedArea.style.display = 'none';
      if (detailsArea) detailsArea.style.display = 'block';

      selectedRequestId = id;
      
      const { data: request, error } = await supabase
        .from('croqui_requests')
        .select('*')
        .eq('id', id)
        .single();

      const detailsEl = document.getElementById('requestDetails');
      if (!detailsEl) return;

      if (error || !request) {
        detailsEl.innerHTML = '<p style="color:red;">Erro ao carregar detalhes.</p>';
        return;
      }

      // --- NOVO: Armazenar o tipo de servi√ßo da solicita√ß√£o ---
      selectedServico = request.servico;

      const municipe = await buscarMunicipePorUserId(request.user_id);
      
      // Mapear o servi√ßo para exibi√ß√£o amig√°vel
      let servicoDisplay = '';
      if (request.servico === 'agua') servicoDisplay = 'üíß √Ågua';
      else if (request.servico === 'luz') servicoDisplay = '‚ö° Luz';
      else if (request.servico === 'agua_e_luz') servicoDisplay = 'üíß‚ö° √Ågua e Luz';
      
      let html = `
        <h2 style="color: #0a4b6e; margin-bottom: 16px;">Detalhes da Solicita√ß√£o</h2>
        <div class="detail-card">
          <div class="detail-row"><span class="detail-label">Nome do mun√≠cipe:</span> <span class="detail-value">${municipe?.full_name || ''}</span></div>
          <div class="detail-row"><span class="detail-label">Nome do pai:</span> <span class="detail-value">${municipe?.father_name || ''}</span></div>
          <div class="detail-row"><span class="detail-label">Nome da m√£e:</span> <span class="detail-value">${municipe?.mother_name || ''}</span></div>
          <div class="detail-row"><span class="detail-label">CPF:</span> <span class="detail-value">${municipe?.cpf || ''}</span></div>
          <div class="detail-row"><span class="detail-label">Identifica√ß√£o do im√≥vel:</span> <span class="detail-value">${request.iptu || ''}</span></div>
          <div class="detail-row"><span class="detail-label">Logradouro:</span> <span class="detail-value">${request.logradouro || ''}</span></div>
          <div class="detail-row"><span class="detail-label">Quadra:</span> <span class="detail-value">${request.quadra || ''}</span></div>
          <div class="detail-row"><span class="detail-label">Lote:</span> <span class="detail-value">${request.lote || ''}</span></div>
          <div class="detail-row"><span class="detail-label">Tipo de liga√ß√£o:</span> <span class="detail-value">${servicoDisplay || ''}</span></div>
          <div class="detail-row"><span class="detail-label">Documento de posse:</span> <span class="detail-value">${request.document_url ? `<a href="${request.document_url}" target="_blank" style="color: #2563eb;">Visualizar documento</a>` : 'N√£o enviado'}</span></div>
        </div>
      `;

      detailsEl.innerHTML = html;
      
      const actionArea = document.getElementById('actionArea');
      if (actionArea) actionArea.style.display = 'block';
      
      const approveArea = document.getElementById('approveArea');
      const denyArea = document.getElementById('denyArea');
      if (approveArea) approveArea.style.display = 'none';
      if (denyArea) denyArea.style.display = 'none';
      
      await carregarPendentes();
    };

    // ========== CARREGAR TABELA DE ATENDIDAS ==========
    async function carregarTabelaAtendidas() {
      const container = document.getElementById('attendedTableContainer');
      if (!container) return;
      container.innerHTML = '<p style="text-align:center; padding: 40px;">Carregando...</p>';

      const { data, error } = await supabase
        .from('croqui_requests')
        .select('*')
        .in('status', ['approved', 'denied', 'forwarded'])
        .order('analyzed_at', { ascending: false });

      if (error) {
        console.error('Erro ao carregar atendidas:', error);
        container.innerHTML = '<p style="color:red;">Erro ao carregar atendidas.</p>';
        return;
      }

      if (!data || data.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding: 40px;">Nenhuma solicita√ß√£o atendida ainda.</p>';
        return;
      }

      let html = `<table>
        <thead>
          <tr>
            <th>Mun√≠cipe</th>
            <th>Endere√ßo</th>
            <th>Status</th>
            <th>Servidor</th>
            <th>RI</th>
            <th>Data</th>
          </tr>
        </thead>
        <tbody>
      `;

      for (const req of data) {
        const municipe = await buscarMunicipePorUserId(req.user_id);
        const servidorInfo = await buscarServidorPorId(req.analyzed_by);
        
        let statusCell = '';
        
        if (req.status === 'approved') {
          statusCell = `<span class="status-link" onclick="window.open('${req.deferred_document_url || ''}', '_blank')" style="cursor: pointer; color: #10b981; font-weight: 600;">
                          ‚úÖ Deferido
                        </span>`;
        } else if (req.status === 'denied') {
          const motivo = (req.denial_reason || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
          statusCell = `<span class="status-link" onclick="alert('‚ùå Motivo do indeferimento:\\n\\n${motivo}')" style="cursor: pointer; color: #ef4444; font-weight: 600;">
                          ‚ùå Indeferido
                        </span>`;
        } else if (req.status === 'forwarded') {
          statusCell = `<span style="color: #2563eb;">‚Ü™Ô∏è Encaminhado</span>`;
        } else {
          statusCell = req.status;
        }
        
        html += `<tr>
          <td>${municipe?.full_name || '-'}</td>
          <td>${req.logradouro || '-'}</td>
          <td>${statusCell}</td>
          <td>${servidorInfo?.nome || '-'}</td>
          <td>${servidorInfo?.ri || '-'}</td>
          <td>${req.analyzed_at ? new Date(req.analyzed_at).toLocaleDateString('pt-BR') : '-'}</td>
        </tr>`;
      }

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    // ========== CONFIGURA√á√ÉO DOS BOT√ïES DE A√á√ÉO ==========
    function setupActionButtons() {
      const approveBtn = document.getElementById('approveBtn');
      const denyBtn = document.getElementById('denyBtn');
      const confirmApprove = document.getElementById('confirmApproveBtn');
      const confirmDeny = document.getElementById('confirmDenyBtn');
      const fileUploadArea = document.getElementById('fileUploadArea');
      const croquiFile = document.getElementById('croquiFile');

      if (approveBtn) {
        approveBtn.addEventListener('click', () => {
          const approveArea = document.getElementById('approveArea');
          const denyArea = document.getElementById('denyArea');
          if (approveArea) approveArea.style.display = 'block';
          if (denyArea) denyArea.style.display = 'none';
        });
      }

      if (denyBtn) {
        denyBtn.addEventListener('click', () => {
          const denyArea = document.getElementById('denyArea');
          const approveArea = document.getElementById('approveArea');
          if (denyArea) denyArea.style.display = 'block';
          if (approveArea) approveArea.style.display = 'none';
        });
      }

      if (fileUploadArea && croquiFile) {
        fileUploadArea.addEventListener('click', () => croquiFile.click());
        croquiFile.addEventListener('change', (e) => {
          const p = fileUploadArea.querySelector('p');
          if (p) {
            p.textContent = e.target.files[0]?.name || 'Clique para enviar o croqui';
          }
        });
      }

      // ========== BOT√ÉO CONFIRMAR DEFERIMENTO (ATUALIZADO) ==========
      if (confirmApprove) {
        confirmApprove.addEventListener('click', async () => {
          if (!selectedRequestId) {
            alert('Nenhuma solicita√ß√£o selecionada.');
            return;
          }

          const fileInput = document.getElementById('croquiFile');
          const file = fileInput?.files[0];
          if (!file) {
            alert('Selecione o arquivo do croqui.');
            return;
          }

          try {
            // 1. Upload do croqui
            const fileName = `croquis/${selectedRequestId}_${Date.now()}.${file.name.split('.').pop()}`;
            const { error: uploadError } = await supabase.storage
              .from('documentos')
              .upload(fileName, file);
            if (uploadError) throw uploadError;

            const { data: urlData } = supabase.storage
              .from('documentos')
              .getPublicUrl(fileName);
            const croquiUrl = urlData.publicUrl;

            // 2. Atualizar a solicita√ß√£o
            const { error: updateError } = await supabase
              .from('croqui_requests')
              .update({
                status: 'approved',
                analyzed_by: servidor.id,
                deferred_document_url: croquiUrl,
                analyzed_at: new Date()
              })
              .eq('id', selectedRequestId);

            if (updateError) throw updateError;

            // ========== NOVO: ENCAMINHAR PARA CONCESSION√ÅRIAS ==========
            // Determinar concession√°rias destino baseado no servi√ßo
            const destinos = [];
            if (selectedServico === 'agua') destinos.push('sabesp');
            else if (selectedServico === 'luz') destinos.push('cpfl');
            else if (selectedServico === 'agua_e_luz') { destinos.push('sabesp'); destinos.push('cpfl'); }

            // Criar tarefas pendentes para cada concession√°ria
            for (const tipo of destinos) {
              const { error: insertTarefaError } = await supabase
                .from('concessao_tarefas')
                .insert([{
                  request_id: selectedRequestId,
                  concessionaria_tipo: tipo,
                  status: 'pending',
                  scheduled_date: null,
                  scheduled_by: null
                }]);
              
              if (insertTarefaError) {
                console.error(`Erro ao encaminhar para ${tipo}:`, insertTarefaError);
              }
            }

            alert('Solicita√ß√£o deferida e encaminhada com sucesso!');
            
            // 3. Limpar campos e UI
            if (fileInput) fileInput.value = '';
            const approveArea = document.getElementById('approveArea');
            if (approveArea) approveArea.style.display = 'none';
            const actionArea = document.getElementById('actionArea');
            if (actionArea) actionArea.style.display = 'none';
            
            const detailsEl = document.getElementById('requestDetails');
            if (detailsEl) {
              detailsEl.innerHTML = '<h2 style="color: #0a4b6e; margin-bottom: 16px;">Detalhes da Solicita√ß√£o</h2><p style="color: #64748b;">Selecione uma solicita√ß√£o na lista ao lado.</p>';
            }
            
            selectedRequestId = null;
            selectedServico = null; // Limpar a vari√°vel de servi√ßo
            
            await carregarPendentes();
            if (document.getElementById('attendedTableArea')?.style.display === 'block') {
              await carregarTabelaAtendidas();
            }
          } catch (err) {
            console.error('Erro ao deferir:', err);
            alert('Erro ao deferir: ' + err.message);
          }
        });
      }

      // ========== BOT√ÉO CONFIRMAR INDEFERIMENTO ==========
      if (confirmDeny) {
        confirmDeny.addEventListener('click', async () => {
          if (!selectedRequestId) {
            alert('Nenhuma solicita√ß√£o selecionada.');
            return;
          }

          const reason = document.getElementById('denyReason')?.value.trim();
          if (!reason) {
            alert('Digite o motivo do indeferimento.');
            return;
          }

          try {
            const { error: updateError } = await supabase
              .from('croqui_requests')
              .update({
                status: 'denied',
                analyzed_by: servidor.id,
                denial_reason: reason,
                analyzed_at: new Date()
              })
              .eq('id', selectedRequestId);

            if (updateError) throw updateError;

            alert('Solicita√ß√£o indeferida com sucesso!');
            
            const denyTextarea = document.getElementById('denyReason');
            if (denyTextarea) denyTextarea.value = '';
            const denyArea = document.getElementById('denyArea');
            if (denyArea) denyArea.style.display = 'none';
            const actionArea = document.getElementById('actionArea');
            if (actionArea) actionArea.style.display = 'none';
            
            const detailsEl = document.getElementById('requestDetails');
            if (detailsEl) {
              detailsEl.innerHTML = '<h2 style="color: #0a4b6e; margin-bottom: 16px;">Detalhes da Solicita√ß√£o</h2><p style="color: #64748b;">Selecione uma solicita√ß√£o na lista ao lado.</p>';
            }
            
            selectedRequestId = null;
            selectedServico = null;
            
            await carregarPendentes();
            if (document.getElementById('attendedTableArea')?.style.display === 'block') {
              await carregarTabelaAtendidas();
            }
          } catch (err) {
            console.error('Erro ao indeferir:', err);
            alert('Erro ao indeferir: ' + err.message);
          }
        });
      }
    }

    // ========== EVENTOS DE NAVEGA√á√ÉO ==========
    const viewAttendedBtn = document.getElementById('viewAttendedBtn');
    const backToDetailsBtn = document.getElementById('backToDetailsBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    if (viewAttendedBtn) {
      viewAttendedBtn.addEventListener('click', async () => {
        const detailsArea = document.getElementById('requestDetailsArea');
        const attendedArea = document.getElementById('attendedTableArea');
        if (detailsArea) detailsArea.style.display = 'none';
        if (attendedArea) attendedArea.style.display = 'block';
        await carregarTabelaAtendidas();
      });
    }

    if (backToDetailsBtn) {
      backToDetailsBtn.addEventListener('click', () => {
        const attendedArea = document.getElementById('attendedTableArea');
        const detailsArea = document.getElementById('requestDetailsArea');
        if (attendedArea) attendedArea.style.display = 'none';
        if (detailsArea) detailsArea.style.display = 'block';
        if (selectedRequestId) {
          window.selecionarSolicitacao(selectedRequestId);
        }
      });
    }

    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('servidor');
        window.location.href = 'servidor-login.html';
      });
    }

    // ========== INICIALIZA√á√ÉO ==========
    (async () => {
      await carregarPendentes();
      setupActionButtons();
    })();
  </script>
</body>
</html>
