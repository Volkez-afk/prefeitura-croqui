<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Servidor - Prefeitura de Botucatu</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .sidebar { float: left; width: 300px; margin-right: 20px; }
    .content { float: left; width: calc(100% - 340px); }
    .clear { clear: both; }
    .panel { background: #f9f9f9; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
    .request-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
    .request-list li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    .request-list li:hover { background: #e6f7ff; }
    .selected { background: #bae7ff; font-weight: bold; }
    .detail-row { margin-bottom: 8px; }
    .detail-label { font-weight: bold; display: inline-block; width: 180px; }
    .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
    .btn-approve { background: #52c41a; color: white; }
    .btn-deny { background: #ff4d4f; color: white; }
    .btn:hover { opacity: 0.9; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f2f2f2; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Painel do Servidor</h2>
      <button id="logoutBtn" class="btn" style="background: #ff4d4f; color: white;">Sair</button>
    </div>

    <div id="loginVerification" style="display: none; background: #fee; padding: 20px;">
      <p style="color: red;">Você não está logado como servidor.</p>
      <a href="servidor-login.html">Ir para login</a>
    </div>

    <div id="mainContent" style="display: none;">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="panel">
          <h3>Servidor</h3>
          <p><strong>Nome:</strong> <span id="servidorNome"></span></p>
          <p><strong>RI:</strong> <span id="servidorRI"></span></p>
        </div>

        <div class="panel">
          <h3>Solicitações Pendentes</h3>
          <ul id="pendingList" class="request-list">
            <li>Carregando...</li>
          </ul>
        </div>

        <div class="panel">
          <h3>Solicitações Atendidas</h3>
          <div id="attendedList" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
      </div>

      <!-- Conteúdo principal -->
      <div class="content">
        <div id="requestDetails" class="panel">
          <h3>Detalhes da Solicitação</h3>
          <p>Selecione uma solicitação na lista ao lado.</p>
        </div>

        <div id="actionArea" style="display: none;">
          <div id="approveArea" style="display: none;">
            <h4>Anexar Croqui (Deferir)</h4>
            <input type="file" id="croquiFile" accept=".pdf,.jpg,.jpeg,.png">
            <button id="confirmApproveBtn" class="btn btn-approve">Confirmar Deferimento</button>
          </div>
          <div id="denyArea" style="display: none;">
            <h4>Motivo do Indeferimento</h4>
            <textarea id="denyReason" rows="4" style="width: 100%;"></textarea>
            <button id="confirmDenyBtn" class="btn btn-deny">Confirmar Indeferimento</button>
          </div>
        </div>

        <div id="message"></div>
      </div>
      <div class="clear"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './js/supabaseClient.js';

    // ===== VERIFICAÇÃO DE LOGIN DO SERVIDOR =====
    const servidorSession = localStorage.getItem('servidor');
    const loginVerification = document.getElementById('loginVerification');
    const mainContent = document.getElementById('mainContent');

    if (!servidorSession) {
      loginVerification.style.display = 'block';
      mainContent.style.display = 'none';
      throw new Error('Servidor não logado');
    }

    let servidor;
    try {
      servidor = JSON.parse(servidorSession);
      document.getElementById('servidorNome').textContent = servidor.nome || 'Servidor';
      document.getElementById('servidorRI').textContent = servidor.ri || '';
    } catch (e) {
      localStorage.removeItem('servidor');
      window.location.href = 'servidor-login.html';
    }

    loginVerification.style.display = 'none';
    mainContent.style.display = 'block';

    // ===== VARIÁVEIS GLOBAIS =====
    let selectedRequestId = null;

    // ===== FUNÇÕES AUXILIARES =====
    async function buscarMunicipePorUserId(userId) {
      const { data, error } = await supabase
        .from('municipes')
        .select('*')
        .eq('id', userId)
        .maybeSingle();
      if (error) {
        console.error('Erro ao buscar munícipe:', error);
        return null;
      }
      return data;
    }

    async function buscarServidorPorId(servidorId) {
      if (!servidorId) return null;
      const { data, error } = await supabase
        .from('servidores')
        .select('nome, ri')
        .eq('id', servidorId)
        .maybeSingle();
      if (error) {
        console.error('Erro ao buscar servidor:', error);
        return null;
      }
      return data;
    }

    // ===== CARREGAR PENDENTES =====
    async function carregarPendentes() {
      const { data, error } = await supabase
        .from('croqui_requests')
        .select('id, user_id, iptu, logradouro, quadra, lote, created_at')
        .eq('status', 'pending')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Erro ao carregar pendentes:', error);
        document.getElementById('pendingList').innerHTML = '<li style="color:red;">Erro ao carregar pendentes.</li>';
        return;
      }

      const listEl = document.getElementById('pendingList');
      if (!data || data.length === 0) {
        listEl.innerHTML = '<li>Nenhuma solicitação pendente.</li>';
        return;
      }

      // Para cada solicitação, busca o nome do munícipe
      let html = '';
      for (const req of data) {
        const municipe = await buscarMunicipePorUserId(req.user_id);
        const nome = municipe?.full_name || 'Desconhecido';
        html += `
          <li onclick="window.selecionarSolicitacao('${req.id}')" class="${selectedRequestId === req.id ? 'selected' : ''}">
            <strong>${nome}</strong><br>
            ${req.logradouro || ''} - ${req.created_at ? new Date(req.created_at).toLocaleDateString('pt-BR') : ''}
          </li>
        `;
      }
      listEl.innerHTML = html;
    }

    // ===== CARREGAR DETALHES =====
    window.selecionarSolicitacao = async (id) => {
      selectedRequestId = id;
      
      const { data: request, error } = await supabase
        .from('croqui_requests')
        .select('*')
        .eq('id', id)
        .single();

      if (error || !request) {
        document.getElementById('requestDetails').innerHTML = '<p style="color:red;">Erro ao carregar detalhes.</p>';
        return;
      }

      const municipe = await buscarMunicipePorUserId(request.user_id);
      
      let html = `
        <h3>Detalhes da Solicitação</h3>
        <div class="detail-row"><span class="detail-label">Nome do munícipe:</span> ${municipe?.full_name || ''}</div>
        <div class="detail-row"><span class="detail-label">Nome do pai:</span> ${municipe?.father_name || ''}</div>
        <div class="detail-row"><span class="detail-label">Nome da mãe:</span> ${municipe?.mother_name || ''}</div>
        <div class="detail-row"><span class="detail-label">CPF:</span> ${municipe?.cpf || ''}</div>
        <div class="detail-row"><span class="detail-label">Identificação do imóvel:</span> ${request.iptu || ''}</div>
        <div class="detail-row"><span class="detail-label">Logradouro:</span> ${request.logradouro || ''}</div>
        <div class="detail-row"><span class="detail-label">Quadra:</span> ${request.quadra || ''}</div>
        <div class="detail-row"><span class="detail-label">Lote:</span> ${request.lote || ''}</div>
        <div class="detail-row"><span class="detail-label">Documento de posse:</span> 
      `;

      if (request.document_url) {
        html += `<a href="${request.document_url}" target="_blank">Visualizar documento</a>`;
      } else {
        html += 'Não enviado';
      }
      html += `</div>`;

      document.getElementById('requestDetails').innerHTML = html;
      document.getElementById('actionArea').style.display = 'block';
      document.getElementById('approveArea').style.display = 'none';
      document.getElementById('denyArea').style.display = 'none';

      await carregarPendentes(); // atualiza classe selected
    };

    // ===== CARREGAR ATENDIDAS =====
    async function carregarAtendidas() {
      const { data, error } = await supabase
        .from('croqui_requests')
        .select('*')
        .in('status', ['approved', 'denied', 'forwarded'])
        .order('analyzed_at', { ascending: false });

      if (error) {
        console.error('Erro ao carregar atendidas:', error);
        document.getElementById('attendedList').innerHTML = '<p style="color:red;">Erro ao carregar atendidas.</p>';
        return;
      }

      if (!data || data.length === 0) {
        document.getElementById('attendedList').innerHTML = '<p>Nenhuma solicitação atendida ainda.</p>';
        return;
      }

      let html = `<table>
        <thead>
          <tr>
            <th>Munícipe</th>
            <th>Endereço</th>
            <th>Status</th>
            <th>Servidor</th>
            <th>RI</th>
            <th>Data</th>
            <th>Motivo (se negado)</th>
            <th>Croqui</th>
          </tr>
        </thead>
        <tbody>
      `;

      for (const req of data) {
        const municipe = await buscarMunicipePorUserId(req.user_id);
        const servidorInfo = await buscarServidorPorId(req.analyzed_by);
        
        const statusMap = {
          approved: '✅ Deferido',
          denied: '❌ Indeferido',
          forwarded: '↪️ Encaminhado'
        };
        
        html += `<tr>
          <td>${municipe?.full_name || '-'}</td>
          <td>${req.logradouro || '-'}</td>
          <td>${statusMap[req.status] || req.status}</td>
          <td>${servidorInfo?.nome || '-'}</td>
          <td>${servidorInfo?.ri || '-'}</td>
          <td>${req.analyzed_at ? new Date(req.analyzed_at).toLocaleDateString('pt-BR') : '-'}</td>
          <td>${req.denial_reason || '-'}</td>
          <td>${req.deferred_document_url ? `<a href="${req.deferred_document_url}" target="_blank">Ver croqui</a>` : '-'}</td>
        </tr>`;
      }

      html += `</tbody></table>`;
      document.getElementById('attendedList').innerHTML = html;
    }

    // ===== CONFIGURAR BOTÕES DE AÇÃO =====
    function setupActionButtons(requestId) {
      // Remove listeners antigos para evitar duplicação
      const approveBtn = document.getElementById('confirmApproveBtn');
      const denyBtn = document.getElementById('confirmDenyBtn');
      
      // Clonar e substituir para remover eventos antigos
      const newApproveBtn = approveBtn.cloneNode(true);
      approveBtn.parentNode.replaceChild(newApproveBtn, approveBtn);
      const newDenyBtn = denyBtn.cloneNode(true);
      denyBtn.parentNode.replaceChild(newDenyBtn, denyBtn);

      document.getElementById('approveBtn').addEventListener('click', () => {
        document.getElementById('approveArea').style.display = 'block';
        document.getElementById('denyArea').style.display = 'none';
      });

      document.getElementById('denyBtn').addEventListener('click', () => {
        document.getElementById('denyArea').style.display = 'block';
        document.getElementById('approveArea').style.display = 'none';
      });

      newApproveBtn.addEventListener('click', async () => {
        const fileInput = document.getElementById('croquiFile');
        const file = fileInput.files[0];
        if (!file) {
          alert('Selecione o arquivo do croqui.');
          return;
        }

        try {
          const fileName = `croquis/${requestId}_${Date.now()}.${file.name.split('.').pop()}`;
          const { error: uploadError } = await supabase.storage
            .from('documentos')
            .upload(fileName, file);
          if (uploadError) throw uploadError;

          const { data: urlData } = supabase.storage
            .from('documentos')
            .getPublicUrl(fileName);
          const croquiUrl = urlData.publicUrl;

          const { error: updateError } = await supabase
            .from('croqui_requests')
            .update({
              status: 'approved',
              analyzed_by: servidor.id,
              deferred_document_url: croquiUrl,
              analyzed_at: new Date()
            })
            .eq('id', requestId);

          if (updateError) throw updateError;

          alert('Solicitação deferida com sucesso!');
          await carregarPendentes();
          await carregarAtendidas();
          document.getElementById('actionArea').style.display = 'none';
          document.getElementById('requestDetails').innerHTML = '<p>Solicitação aprovada. Selecione outra.</p>';
          selectedRequestId = null;
        } catch (err) {
          console.error(err);
          alert('Erro ao deferir: ' + err.message);
        }
      });

      newDenyBtn.addEventListener('click', async () => {
        const reason = document.getElementById('denyReason').value.trim();
        if (!reason) {
          alert('Digite o motivo do indeferimento.');
          return;
        }

        try {
          const { error: updateError } = await supabase
            .from('croqui_requests')
            .update({
              status: 'denied',
              analyzed_by: servidor.id,
              denial_reason: reason,
              analyzed_at: new Date()
            })
            .eq('id', requestId);

          if (updateError) throw updateError;

          alert('Solicitação indeferida com sucesso!');
          await carregarPendentes();
          await carregarAtendidas();
          document.getElementById('actionArea').style.display = 'none';
          document.getElementById('requestDetails').innerHTML = '<p>Solicitação negada. Selecione outra.</p>';
          selectedRequestId = null;
        } catch (err) {
          console.error(err);
          alert('Erro ao indeferir: ' + err.message);
        }
      });
    }

    // ===== BOTÕES PRINCIPAIS =====
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('servidor');
      window.location.href = 'servidor-login.html';
    });

    // ===== INICIALIZAÇÃO =====
    (async () => {
      await carregarPendentes();
      await carregarAtendidas();
    })();
  </script>
</body>
</html>
